/**
 * @file Firestore Security Rules for DeepLearn Pro
 *
 * @description This ruleset enforces a strict user-ownership model for user profiles and project submissions,
 * allowing users to only access their own data. Public read access is granted to projects and discussions,
 * with owner-only write access. Data consistency between document IDs and path parameters is enforced for
 * user-scoped data.
 *
 * @dataStructure
 * - `/users/{userId}`: Stores user data.
 * - `/users/{userId}/userProfiles/{profileId}`: Stores user profile information (1:1 with User).
 * - `/users/{userId}/projectSubmissions/{submissionId}`: Stores project submissions for a user.
 * - `/projects/{projectId}`: Stores project information.
 * - `/discussions/{postId}`: Stores discussion posts.
 *
 * @keySecurityDecisions
 * - User listing is implicitly denied.
 * - Read-only access is granted to the `/projects` and `/discussions` collections.
 * - The `userId` is denormalized within `userProfiles` and `projectSubmissions` to simplify authorization rules.
 * - Data consistency between the path and document `userId` is enforced on create and update.
 * - Destructive operations require existence checks.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secure user documents. Only the user can read/write their own document.
     * @path /users/{userId}
     * @allow (create) User with ID 'user123' can create their own document.
     *   - Request: { "auth": { "uid": "user123" }, "resource": { "data": { "id": "user123", "username": "testuser", "email": "test@example.com" } } }
     * @allow (get, update, delete) User with ID 'user123' can get, update, and delete their own document.
     *   - Request: { "auth": { "uid": "user123" } }
     * @deny (create) User with ID 'user456' cannot create a document for user 'user123'.
     *   - Request: { "auth": { "uid": "user456" }, "resource": { "data": { "id": "user123", "username": "testuser", "email": "test@example.com" } } }
     * @deny (get, update, delete) User with ID 'user456' cannot get, update, or delete the document for user 'user123'.
     *   - Request: { "auth": { "uid": "user456" } }
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      allow get: if isOwner(userId);
      allow list: if false; // User listing is not permitted.
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isOwner(userId) && resource != null && request.resource.data.id == resource.data.id;
      allow delete: if isOwner(userId) && resource != null;
    }

    /**
     * @description Secure user profile documents. Only the owning user can create, read, update, or delete their own profile.
     * @path /users/{userId}/userProfiles/{profileId}
     * @allow (create) User with ID 'user123' can create their profile.
     *   - Request: { "auth": { "uid": "user123" }, "resource": { "data": { "userId": "user123", "id": "user123", "name": "Test User", "email": "test@example.com", "solvedProjects": 0, "coursesCompleted": 0 } } }
     * @allow (get, update, delete) User with ID 'user123' can get, update, and delete their own profile.
     *   - Request: { "auth": { "uid": "user123" } }
     * @deny (create) User with ID 'user456' cannot create a profile for user 'user123'.
     *   - Request: { "auth": { "uid": "user456" }, "resource": { "data": { "userId": "user123", "id": "user123", "name": "Test User", "email": "test@example.com", "solvedProjects": 0, "coursesCompleted": 0 } } }
     * @deny (get, update, delete) User with ID 'user456' cannot get, update, or delete the profile for user 'user123'.
     *   - Request: { "auth": { "uid": "user456" } }
     * @principle Enforces document ownership for all operations on user profiles.
     */
    match /users/{userId}/userProfiles/{profileId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId && request.resource.data.id == userId;
      allow update: if isOwner(userId) && resource != null && request.resource.data.userId == resource.data.userId && request.resource.data.id == resource.data.id;
      allow delete: if isOwner(userId) && resource != null;
    }

    /**
     * @description Secure project submission documents. Only the owning user can create, read, update, or delete their own submissions.
     * @path /users/{userId}/projectSubmissions/{submissionId}
     * @allow (create) User with ID 'user123' can create a submission.
     *   - Request: { "auth": { "uid": "user123" }, "resource": { "data": { "userId": "user123", "projectId": "project456", "submissionDate": "2024-01-01T00:00:00Z", "filePath": "/path/to/file", "isCorrect": true, "feedback": "Good job!", "id": "submission789" } } }
     * @allow (get, update, delete) User with ID 'user123' can get, update, and delete their own submissions.
     *   - Request: { "auth": { "uid": "user123" } }
     * @deny (create) User with ID 'user456' cannot create a submission for user 'user123'.
     *   - Request: { "auth": { "uid": "user456" }, "resource": { "data": { "userId": "user123", "projectId": "project456", "submissionDate": "2024-01-01T00:00:00Z", "filePath": "/path/to/file", "isCorrect": true, "feedback": "Good job!", "id": "submission789" } } }
     * @deny (get, update, delete) User with ID 'user456' cannot get, update, or delete the submission for user 'user123'.
     *   - Request: { "auth": { "uid": "user456" } }
     * @principle Enforces document ownership for all operations on project submissions.
     */
    match /users/{userId}/projectSubmissions/{submissionId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isOwner(userId) && resource != null && request.resource.data.userId == resource.data.userId;
      allow delete: if isOwner(userId) && resource != null;
    }

    /**
     * @description Allow public read access to projects, but enforce owner-only writes.
     * @path /projects/{projectId}
     * @allow (get, list) Any user (authenticated or not) can read projects.
     *   - Request: { "auth": null }
     * @allow (create) User with ID 'user123' can create a project with themselves as the owner.
     *   - Request: { "auth": { "uid": "user123" }, "resource": { "data": { "id": "project456", "title": "Test Project", "description": "A test project", "difficultyLevel": "Beginner", "topic": "ML" } } }
     * @allow (update, delete) User with ID 'user123' can update and delete a project they own.
     *   - Request: { "auth": { "uid": "user123" } }
     * @deny (create) User with ID 'user456' cannot create a project on behalf of user 'user123'.
     *   - Request: { "auth": { "uid": "user456" }, "resource": { "data": { "id": "project456", "title": "Test Project", "description": "A test project", "difficultyLevel": "Beginner", "topic": "ML" } } }
     * @deny (update, delete) User with ID 'user456' cannot update or delete a project owned by user 'user123'.
     *   - Request: { "auth": { "uid": "user456" } }
     * @principle Allows public reads, enforces document ownership for writes.
     */
    match /projects/{projectId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Allow public read access to discussions, but enforce owner-only writes.
     * @path /discussions/{postId}
     * @allow (get, list) Any user (authenticated or not) can read discussions.
     *   - Request: { "auth": null }
     * @allow (create) User with ID 'user123' can create a discussion post with themselves as the owner.
     *   - Request: { "auth": { "uid": "user123" }, "resource": { "data": { "id": "post456", "userId": "user123", "userName": "Test User", "title": "Test Post", "content": "Hello world!", "createdAt": "2024-01-01T00:00:00Z" } } }
     * @allow (update, delete) User with ID 'user123' can update and delete a discussion post they own.
     *   - Request: { "auth": { "uid": "user123" } }
     * @deny (create) User with ID 'user456' cannot create a discussion post on behalf of user 'user123'.
     *   - Request: { "auth": { "uid": "user456" }, "resource": { "data": { "id": "post456", "userId": "user123", "userName": "Test User", "title": "Test Post", "content": "Hello world!", "createdAt": "2024-01-01T00:00:00Z" } } }
     * @deny (update, delete) User with ID 'user456' cannot update or delete a discussion post owned by user 'user123'.
     *   - Request: { "auth": { "uid": "user456" } }
     * @principle Allows public reads, enforces document ownership for writes.
     */
    match /discussions/{postId} {
        function isSignedIn() {
            return request.auth != null;
        }
        allow get, list: if true;
        allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
        allow update: if isSignedIn() && resource.data.userId == request.auth.uid;
        allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }
  }
}